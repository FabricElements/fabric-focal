<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

  <title>skeleton-focal test</title>

  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <script src="../../iron-test-helpers/mock-interactions.js"></script>

  <link rel="import" href="../skeleton-focal.html">
</head>
<body>

  <test-fixture id="basicDefault">
    <template>
      <skeleton-focal></skeleton-focal>
    </template>
  </test-fixture>

  <test-fixture id="basicImage">
    <template>
      <skeleton-focal src="images/testing.jpg"></skeleton-focal>
    </template>
  </test-fixture>

  <script>

    function getCenter(box) {
      return {
        x: box.left + (box.width / 2),
        y: box.top + (box.height / 2),
      };
    }

    suite('basic behavior', function() {
      test('instantiating the element with default properties works', function() {
        const element = fixture('basicDefault');

        expect(element.x).to.equal(0.5);
        expect(element.y).to.equal(0.5);
      });
    });

    suite('dragging behavior', function() {
      let element;
      let dragIcon;
      let drag;
      let image;

      setup(function() {
        element = fixture('basicImage');
        dragIcon = element.shadowRoot.querySelector('#dragIcon');
        drag = element.shadowRoot.querySelector('#drag');
        image = element.shadowRoot.querySelector('iron-image');
      });

      test('the handle center should be aligned with the image center by default', function(done) {
        image.addEventListener('loaded-changed', function onLoadedChanged() {
          if (!image.loaded) return;

          const imageBounds = image.getBoundingClientRect();
          const dragIconBounds = dragIcon.getBoundingClientRect();

          expect(
            getCenter(imageBounds)
          ).to.deep.equal(
            getCenter(dragIconBounds)
          );

          done();
        });
      });

      test('when dragging the handle to the top left x and y properties should update', function(done) {
        image.addEventListener('loaded-changed', function onLoadedChanged() {
          if (!image.loaded) return;

          const imageBounds = image.getBoundingClientRect();
          const imageTopLeftCorner = {
            x: imageBounds.left,
            y: imageBounds.top,
          };

          MockInteractions.track(drag, -imageBounds.width / 2, -imageBounds.height / 2);

          const dragBounds = drag.getBoundingClientRect();

          expect(element.x).to.equal(0);
          expect(element.y).to.equal(0);

          expect(getCenter(dragBounds)).to.deep.equal(imageTopLeftCorner);
          done();
        });
      });

      test('when dragging the handle to the bottom left x and y properties should update', function(done) {
        image.addEventListener('loaded-changed', function onLoadedChanged() {
          if (!image.loaded) return;

          const imageBounds = image.getBoundingClientRect();
          const imageBottomLeftCorner = {
            x: imageBounds.left,
            y: imageBounds.top + imageBounds.height,
          };

          MockInteractions.track(drag, -imageBounds.width / 2, imageBounds.height / 2);

          const dragBounds = drag.getBoundingClientRect();

          expect(element.x).to.equal(0);
          expect(element.y).to.equal(1);

          expect(getCenter(dragBounds)).to.deep.equal(imageBottomLeftCorner);
          done();
        });
      });

      test('when dragging the handle to the top right x and y properties should update', function(done) {
        image.addEventListener('loaded-changed', function onLoadedChanged() {
          if (!image.loaded) return;

          const imageBounds = image.getBoundingClientRect();
          const imageTopRightCorner = {
            x: imageBounds.left + imageBounds.width,
            y: imageBounds.top,
          };

          MockInteractions.track(drag, imageBounds.width / 2, -imageBounds.height / 2);

          const dragBounds = drag.getBoundingClientRect();

          expect(element.x).to.equal(1);
          expect(element.y).to.equal(0);

          expect(getCenter(dragBounds)).to.deep.equal(imageTopRightCorner);
          done();
        });
      });

      test('when dragging the handle to the bottom right x and y properties should update', function(done) {
        image.addEventListener('loaded-changed', function onLoadedChanged() {
          if (!image.loaded) return;

          const imageBounds = image.getBoundingClientRect();
          const imageBottomRightCorner = {
            x: imageBounds.left + imageBounds.width,
            y: imageBounds.top + imageBounds.height,
          };

          MockInteractions.track(drag, imageBounds.width / 2, imageBounds.height / 2);

          const dragBounds = drag.getBoundingClientRect();

          expect(element.x).to.equal(1);
          expect(element.y).to.equal(1);

          expect(getCenter(dragBounds)).to.deep.equal(imageBottomRightCorner);
          done();
        });
      });
    });
  </script>

</body>
</html>
